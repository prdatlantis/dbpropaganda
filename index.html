<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestionale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d0d0d;
            color: #e0e0e0;
        }

        /* LOGIN PAGE */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: #1a1a1b;
            border-radius: 12px;
            padding: 50px 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
        }

        .login-logo {
            text-align: center;
            font-size: 48px;
            margin-bottom: 15px;
        }

        .login-title {
            text-align: center;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .login-subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #aaa;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #2a2a2b;
            color: #e0e0e0;
            font-size: 15px;
            transition: border 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #28a745;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: #28a745;
            color: white;
            width: 100%;
            padding: 14px;
            font-size: 16px;
        }

        .btn-primary:hover {
            background: #218838;
        }

        .btn-primary:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #555;
            color: white;
        }

        .btn-secondary:hover {
            background: #666;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        /* MAIN APP */
        .app-container {
            display: none;
            padding-top: 60px;
        }

        .app-container.active {
            display: block;
        }

        /* NAVBAR */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1a1a1b;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .navbar-menu {
            display: flex;
            gap: 40px;
            list-style: none;
        }

        .navbar-menu li {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.2s;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .navbar-menu li:hover {
            background: #2a2a2b;
        }

        .navbar-menu li.active {
            background: #333;
            color: #fff;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            background: #2a2a2b;
            border-radius: 20px;
            font-size: 14px;
        }

        .user-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-badge.owner {
            background: #ffd700;
            color: #000;
        }

        .user-badge.direzione {
            background: #28a745;
            color: #fff;
        }

        .user-badge.utente {
            background: #555;
            color: #fff;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* CONTAINER */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-size: 28px;
            font-weight: 600;
        }

        /* FLOATING BUTTON */
        .floating-btn {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #28a745;
            color: white;
            border: none;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(40, 167, 69, 0.6);
        }

        /* TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1b;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #2a2a2b;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            color: #aaa;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #2a2a2b;
        }

        tr:hover {
            background: #242424;
        }

        /* SELECT STATO */
        .stato-select {
            padding: 6px 12px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #2a2a2b;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
        }

        .stato-select.neutro {
            background: #444;
            color: #fff;
        }

        .stato-select.verificato {
            background: rgba(40, 167, 69, 0.3);
            color: #28a745;
            border-color: #28a745;
        }

        .stato-select.non-verificato {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
            border-color: #dc3545;
        }

        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a1b;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 25px;
            font-size: 24px;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #2a2a2b;
            color: #e0e0e0;
            font-size: 14px;
        }

        .form-group select:focus {
            outline: none;
            border-color: #28a745;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-buttons button {
            flex: 1;
        }

        /* STIPENDI MODAL */
        .stipendi-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .stipendio-item {
            padding: 15px;
            background: #2a2a2b;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stipendio-nome {
            font-weight: 600;
            font-size: 16px;
        }

        .stipendio-dettagli {
            color: #aaa;
            font-size: 13px;
            margin-top: 4px;
        }

        .stipendio-importo {
            font-size: 22px;
            font-weight: 700;
            color: #28a745;
        }

        /* LOADER */
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .loader.active {
            display: block;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        /* USER STATUS */
        .user-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .user-status.active {
            background: #28a745;
        }

        .user-status.inactive {
            background: #dc3545;
        }

        /* CHECKBOX */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- LOGIN PAGE -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <div class="login-logo">üîê</div>
            <h1 class="login-title">Sistema Gestionale</h1>
            <p class="login-subtitle">Accedi con le tue credenziali</p>
            
            <div id="login-error" class="error-message" style="display: none;"></div>
            
            <form id="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" placeholder="Inserisci username" required autofocus>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" placeholder="Inserisci password" required>
                </div>
                <button type="submit" class="btn btn-primary" id="login-btn">Accedi</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="app">
        
        <!-- NAVBAR -->
        <nav class="navbar">
            <ul class="navbar-menu">
                <li class="active" data-section="registro">REGISTRO</li>
                <li data-section="dipendenti">DIPENDENTI</li>
                <li data-section="ruoli">RUOLI</li>
                <li data-section="utenti" id="nav-utenti" style="display: none;">UTENTI</li>
            </ul>
            <div class="navbar-user">
                <div class="user-info">
                    <span id="username-display"></span>
                    <span class="user-badge" id="role-badge"></span>
                </div>
                <button class="logout-btn" onclick="logout()">Esci</button>
            </div>
        </nav>

        <div class="container">
            
            <!-- SEZIONE REGISTRO -->
            <section id="registro" class="section active">
                <div class="section-header">
                    <h2>Registro Tesseramenti</h2>
                    <button class="btn btn-primary" onclick="openModal('tesseramento')">Aggiungi Tesseramento</button>
                </div>
                
                <div class="loader" id="loader-registro"></div>
                
                <table id="table-registro" style="display:none;">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Propagandista</th>
                            <th>Tesserato</th>
                            <th>Lavoro</th>
                            <th>@TG</th>
                            <th>@DS</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-registro"></tbody>
                </table>
                
                <div class="empty-state" id="empty-registro" style="display:none;">
                    <h3>Nessun tesseramento presente</h3>
                    <p>Aggiungi il primo tesseramento per iniziare</p>
                </div>
            </section>

            <!-- SEZIONE DIPENDENTI -->
            <section id="dipendenti" class="section">
                <div class="section-header">
                    <h2>Gestione Dipendenti</h2>
                    <button class="btn btn-primary" onclick="openModal('dipendente')">Aggiungi Propagandista</button>
                </div>
                
                <div class="loader" id="loader-dipendenti"></div>
                
                <table id="table-dipendenti" style="display:none;">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Ruolo</th>
                            <th>Paga</th>
                            <th>Username TG</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-dipendenti"></tbody>
                </table>
                
                <div class="empty-state" id="empty-dipendenti" style="display:none;">
                    <h3>Nessun dipendente presente</h3>
                    <p>Aggiungi il primo propagandista</p>
                </div>
            </section>

            <!-- SEZIONE RUOLI -->
            <section id="ruoli" class="section">
                <div class="section-header">
                    <h2>Gestione Ruoli</h2>
                    <button class="btn btn-primary" onclick="openModal('ruolo')">Crea Ruolo</button>
                </div>
                
                <div class="loader" id="loader-ruoli"></div>
                
                <table id="table-ruoli" style="display:none;">
                    <thead>
                        <tr>
                            <th>Nome Ruolo</th>
                            <th>Paga per Tesseramento</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-ruoli"></tbody>
                </table>
                
                <div class="empty-state" id="empty-ruoli" style="display:none;">
                    <h3>Nessun ruolo presente</h3>
                    <p>Crea il primo ruolo</p>
                </div>
            </section>

            <!-- SEZIONE UTENTI (Solo Direzione) -->
            <section id="utenti" class="section">
                <div class="section-header">
                    <h2>Gestione Utenti</h2>
                    <button class="btn btn-primary" onclick="openModal('utente')">Crea Utente</button>
                </div>
                
                <div class="loader" id="loader-utenti"></div>
                
                <table id="table-utenti" style="display:none;">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Ruolo</th>
                            <th>Stato</th>
                            <th>Creato da</th>
                            <th>Ultimo accesso</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-utenti"></tbody>
                </table>
                
                <div class="empty-state" id="empty-utenti" style="display:none;">
                    <h3>Nessun utente presente</h3>
                    <p>Crea il primo utente</p>
                </div>
            </section>

        </div>

        <!-- FLOATING BUTTON -->
        <button class="floating-btn" onclick="calcolaStipendi()" title="Calcola Stipendi">üíæ</button>

    </div>

    <!-- MODAL TESSERAMENTO -->
    <div class="modal-overlay" id="modal-tesseramento">
        <div class="modal">
            <h3>Nuovo Tesseramento</h3>
            <form id="form-tesseramento">
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" name="data" required>
                </div>
                <div class="form-group">
                    <label>Propagandista</label>
                    <select name="propagandista" id="select-propagandista" required>
                        <option value="">Seleziona...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tesserato</label>
                    <input type="text" name="tesserato" placeholder="Nome tesserato" required>
                </div>
                <div class="form-group">
                    <label>Lavoro</label>
                    <input type="text" name="lavoro" placeholder="Tipo di lavoro" required>
                </div>
                <div class="form-group">
                    <label>@TG (opzionale)</label>
                    <input type="text" name="telegram" placeholder="Username Telegram">
                </div>
                <div class="form-group">
                    <label>@DS (opzionale)</label>
                    <input type="text" name="discord" placeholder="Username Discord">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('tesseramento')">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DIPENDENTE -->
    <div class="modal-overlay" id="modal-dipendente">
        <div class="modal">
            <h3>Nuovo Propagandista</h3>
            <form id="form-dipendente">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" name="nome" placeholder="Nome completo" required>
                </div>
                <div class="form-group">
                    <label>Ruolo</label>
                    <select name="ruolo_id" id="select-ruolo" required>
                        <option value="">Seleziona...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Username Telegram (opzionale)</label>
                    <input type="text" name="telegram_user" placeholder="@username">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('dipendente')">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL RUOLO -->
    <div class="modal-overlay" id="modal-ruolo">
        <div class="modal">
            <h3>Nuovo Ruolo</h3>
            <form id="form-ruolo">
                <div class="form-group">
                    <label>Nome Ruolo</label>
                    <input type="text" name="nome" placeholder="Es: Propagandista Senior" required>
                </div>
                <div class="form-group">
                    <label>Paga per Tesseramento</label>
                    <input type="number" step="0.01" name="paga" placeholder="0.00" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('ruolo')">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL UTENTE -->
    <div class="modal-overlay" id="modal-utente">
        <div class="modal">
            <h3>Nuovo Utente</h3>
            <form id="form-utente">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" placeholder="Username univoco" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" placeholder="Password sicura" required>
                </div>
                <div class="form-group">
                    <label>Ruolo Sistema</label>
                    <select name="ruolo_sistema" required>
                        <option value="">Seleziona...</option>
                        <option value="utente">Utente</option>
                        <option value="direzione">Direzione</option>
                        <option value="owner" id="option-owner">Owner</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('utente')">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Utente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL MODIFICA UTENTE -->
    <div class="modal-overlay" id="modal-modifica-utente">
        <div class="modal">
            <h3>Modifica Utente</h3>
            <form id="form-modifica-utente">
                <input type="hidden" name="user_id" id="edit-user-id">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit-username" disabled style="opacity: 0.6;">
                </div>
                <div class="form-group">
                    <label>Nuova Password (lascia vuoto per non modificare)</label>
                    <input type="password" name="password" placeholder="Nuova password">
                </div>
                <div class="form-group">
                    <label>Ruolo Sistema</label>
                    <select name="ruolo_sistema" id="edit-ruolo" required>
                        <option value="utente">Utente</option>
                        <option value="direzione">Direzione</option>
                        <option value="owner">Owner</option>
                    </select>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" name="attivo" id="edit-attivo">
                    <label for="edit-attivo">Account Attivo</label>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modifica-utente')">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL STIPENDI -->
    <div class="modal-overlay" id="modal-stipendi">
        <div class="modal">
            <h3>Calcolo Stipendi</h3>
            <div class="stipendi-list" id="stipendi-list"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="closeModal('stipendi')">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
       // ============================================================
        // CONFIGURAZIONE API CON AUTO-DISCOVERY
        // ============================================================
        
        // Il backend invier√† il proprio indirizzo alla prima connessione
        let API_BASE_URL = localStorage.getItem('api_url') || null;
        
        // Funzione per trovare automaticamente il backend
        async function discoverBackend() {
            const savedUrl = localStorage.getItem('api_url');
            if (savedUrl) {
                // Verifica se l'URL salvato funziona ancora
                try {
                    const response = await fetch(`${savedUrl}/api/ping`, {
                        method: 'GET',
                        signal: AbortSignal.timeout(2000)
                    });
                    if (response.ok) {
                        API_BASE_URL = savedUrl;
                        return true;
                    }
                } catch (e) {
                    localStorage.removeItem('api_url');
                }
            }
            
            // Mostra modal per inserire IP manualmente
            return false;
        }
        
        // Modal per inserimento IP manuale
        function showIpConfigModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal">
                    <h3>‚öôÔ∏è Configurazione Backend</h3>
                    <p style="color: #aaa; margin-bottom: 20px;">
                        Inserisci l'indirizzo IP del server Python.<br>
                        Lo trovi nelle impostazioni WiFi del telefono.
                    </p>
                    <div class="form-group">
                        <label>Indirizzo IP</label>
                        <input type="text" id="ip-input" placeholder="192.168.1.50" value="192.168.1.">
                    </div>
                    <div class="form-group">
                        <label>Porta</label>
                        <input type="text" id="port-input" value="5000">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveBackendUrl()" style="flex: 1;">Salva e Connetti</button>
                    </div>
                    <div id="connection-error" class="error-message" style="display: none; margin-top: 15px;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('ip-input').focus();
        }
        
        async function saveBackendUrl() {
            const ip = document.getElementById('ip-input').value.trim();
            const port = document.getElementById('port-input').value.trim();
            const errorDiv = document.getElementById('connection-error');
            
            if (!ip) {
                errorDiv.textContent = 'Inserisci un indirizzo IP valido';
                errorDiv.style.display = 'block';
                return;
            }
            
            const url = `http://${ip}:${port}`;
            errorDiv.style.display = 'none';
            
            // Test connessione
            try {
                const response = await fetch(`${url}/api/ping`, {
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    API_BASE_URL = url;
                    localStorage.setItem('api_url', url);
                    
                    // Chiudi modal
                    document.querySelector('.modal-overlay').remove();
                    
                    // Ricarica
                    location.reload();
                } else {
                    throw new Error('Server non raggiungibile');
                }
            } catch (error) {
                errorDiv.textContent = `‚ùå Impossibile connettersi a ${url}. Verifica IP e porta.`;
                errorDiv.style.display = 'block';
            }
        }

        // ============================================================
        // NAVIGATION
        // ============================================================
        document.querySelectorAll('.navbar-menu li').forEach(item => {
            item.addEventListener('click', function() {
                const section = this.dataset.section;
                
                document.querySelectorAll('.navbar-menu li').forEach(li => li.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                if (section === 'registro') loadTesseramenti();
                if (section === 'dipendenti') loadDipendenti();
                if (section === 'ruoli') loadRuoli();
                if (section === 'utenti') loadUtenti();
            });
        });

        // ============================================================
        // MODAL MANAGEMENT
        // ============================================================
        function openModal(type) {
            if (type === 'dipendente' || type === 'tesseramento') {
                loadRuoliSelect();
            }
            if (type === 'tesseramento') {
                loadPropagandistiSelect();
            }
            document.getElementById(`modal-${type}`).classList.add('active');
        }

        function closeModal(type) {
            document.getElementById(`modal-${type}`).classList.remove('active');
        }

        // ============================================================
        // API CALLS
        // ============================================================
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (response.status === 401) {
                    alert('Sessione scaduta. Effettua nuovamente il login.');
                    logout();
                    throw new Error('Unauthorized');
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                if (error.message !== 'Unauthorized') {
                    alert(`Errore: ${error.message}`);
                }
                throw error;
            }
        }

        // ============================================================
        // TESSERAMENTI
        // ============================================================
        async function loadTesseramenti() {
            showLoader('registro');
            try {
                tesseramentiData = await apiCall('/api/tesseramenti');
                renderTesseramenti();
            } catch (error) {
                showEmpty('registro');
            }
        }

        function renderTesseramenti() {
            const tbody = document.getElementById('tbody-registro');
            tbody.innerHTML = '';
            
            if (tesseramentiData.length === 0) {
                showEmpty('registro');
                return;
            }
            
            hideLoader('registro');
            document.getElementById('table-registro').style.display = 'table';
            
            tesseramentiData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.data}</td>
                    <td>${item.propagandista}</td>
                    <td>${item.tesserato}</td>
                    <td>${item.lavoro}</td>
                    <td>${item.telegram || '-'}</td>
                    <td>${item.discord || '-'}</td>
                    <td>
                        <select class="stato-select ${item.stato.toLowerCase().replace(' ', '-')}" 
                                onchange="updateStato(${item.id}, this.value)">
                            <option value="Neutro" ${item.stato === 'Neutro' ? 'selected' : ''}>Neutro</option>
                            <option value="Verificato" ${item.stato === 'Verificato' ? 'selected' : ''}>Verificato</option>
                            <option value="Non Verificato" ${item.stato === 'Non Verificato' ? 'selected' : ''}>Non Verificato</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteTesseramento(${item.id})">Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function updateStato(id, stato) {
            await apiCall(`/api/tesseramenti/${id}`, 'PUT', { stato });
            loadTesseramenti();
        }

        async function deleteTesseramento(id) {
            if (!confirm('Confermi di voler eliminare questo tesseramento?')) return;
            await apiCall(`/api/tesseramenti/${id}`, 'DELETE');
            loadTesseramenti();
        }

        document.getElementById('form-tesseramento').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            await apiCall('/api/tesseramenti', 'POST', data);
            closeModal('tesseramento');
            this.reset();
            loadTesseramenti();
        });

        // ============================================================
        // DIPENDENTI
        // ============================================================
        async function loadDipendenti() {
            showLoader('dipendenti');
            try {
                dipendentiData = await apiCall('/api/dipendenti');
                renderDipendenti();
            } catch (error) {
                showEmpty('dipendenti');
            }
        }

        function renderDipendenti() {
            const tbody = document.getElementById('tbody-dipendenti');
            tbody.innerHTML = '';
            
            if (dipendentiData.length === 0) {
                showEmpty('dipendenti');
                return;
            }
            
            hideLoader('dipendenti');
            document.getElementById('table-dipendenti').style.display = 'table';
            
            dipendentiData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.nome}</td>
                    <td>${item.ruolo_nome || '-'}</td>
                    <td>${item.paga ? item.paga.toFixed(2) + ' ‚Ç¨' : '-'}</td>
                    <td>${item.telegram_user || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteDipendente(${item.id})">Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteDipendente(id) {
            if (!confirm('Confermi di voler eliminare questo dipendente?')) return;
            await apiCall(`/api/dipendenti/${id}`, 'DELETE');
            loadDipendenti();
        }

        document.getElementById('form-dipendente').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            await apiCall('/api/dipendenti', 'POST', data);
            closeModal('dipendente');
            this.reset();
            loadDipendenti();
        });

        // ============================================================
        // RUOLI
        // ============================================================
        async function loadRuoli() {
            showLoader('ruoli');
            try {
                ruoliData = await apiCall('/api/ruoli');
                renderRuoli();
            } catch (error) {
                showEmpty('ruoli');
            }
        }

        function renderRuoli() {
            const tbody = document.getElementById('tbody-ruoli');
            tbody.innerHTML = '';
            
            if (ruoliData.length === 0) {
                showEmpty('ruoli');
                return;
            }
            
            hideLoader('ruoli');
            document.getElementById('table-ruoli').style.display = 'table';
            
            ruoliData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.nome}</td>
                    <td>${item.paga.toFixed(2)} ‚Ç¨</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRuolo(${item.id})">Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteRuolo(id) {
            if (!confirm('Confermi di voler eliminare questo ruolo?')) return;
            await apiCall(`/api/ruoli/${id}`, 'DELETE');
            loadRuoli();
        }

        document.getElementById('form-ruolo').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            await apiCall('/api/ruoli', 'POST', data);
            closeModal('ruolo');
            this.reset();
            loadRuoli();
        });

        // ============================================================
        // UTENTI (Solo Direzione)
        // ============================================================
        async function loadUtenti() {
            showLoader('utenti');
            try {
                utentiData = await apiCall('/api/utenti');
                renderUtenti();
            } catch (error) {
                showEmpty('utenti');
            }
        }

        function renderUtenti() {
            const tbody = document.getElementById('tbody-utenti');
            tbody.innerHTML = '';
            
            if (utentiData.length === 0) {
                showEmpty('utenti');
                return;
            }
            
            hideLoader('utenti');
            document.getElementById('table-utenti').style.display = 'table';
            
            utentiData.forEach(item => {
                const tr = document.createElement('tr');
                const statusClass = item.attivo ? 'active' : 'inactive';
                const statusText = item.attivo ? 'Attivo' : 'Disattivato';
                const lastLogin = item.last_login ? new Date(item.last_login).toLocaleString('it-IT') : 'Mai';
                
                const canEdit = item.username !== 'SonoAlby1';
                
                tr.innerHTML = `
                    <td>${item.username}</td>
                    <td><span class="user-badge ${item.ruolo_sistema}">${item.ruolo_sistema}</span></td>
                    <td><span class="user-status ${statusClass}"></span>${statusText}</td>
                    <td>${item.creato_da || '-'}</td>
                    <td>${lastLogin}</td>
                    <td>
                        ${canEdit ? `
                            <button class="btn btn-secondary" onclick="editUtente(${item.id})" style="margin-right: 10px;">Modifica</button>
                            <button class="btn btn-danger" onclick="deleteUtente(${item.id})">Elimina</button>
                        ` : '<span style="color: #888;">Account protetto</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editUtente(id) {
            const user = utentiData.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-ruolo').value = user.ruolo_sistema;
            document.getElementById('edit-attivo').checked = user.attivo === 1;
            
            openModal('modifica-utente');
        }

        async function deleteUtente(id) {
            if (!confirm('Confermi di voler eliminare questo utente?')) return;
            await apiCall(`/api/utenti/${id}`, 'DELETE');
            loadUtenti();
        }

        document.getElementById('form-utente').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            try {
                await apiCall('/api/utenti', 'POST', data);
                closeModal('utente');
                this.reset();
                loadUtenti();
            } catch (error) {
                // Error already shown by apiCall
            }
        });

        document.getElementById('form-modifica-utente').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const userId = formData.get('user_id');
            const data = {
                ruolo_sistema: formData.get('ruolo_sistema'),
                attivo: formData.get('attivo') === 'on'
            };
            
            if (formData.get('password')) {
                data.password = formData.get('password');
            }
            
            try {
                await apiCall(`/api/utenti/${userId}`, 'PUT', data);
                closeModal('modifica-utente');
                this.reset();
                loadUtenti();
            } catch (error) {
                // Error already shown
            }
        });

        // ============================================================
        // SELECT POPULATIONS
        // ============================================================
        async function loadRuoliSelect() {
            const select = document.getElementById('select-ruolo');
            const ruoli = await apiCall('/api/ruoli');
            
            select.innerHTML = '<option value="">Seleziona...</option>';
            ruoli.forEach(r => {
                const option = document.createElement('option');
                option.value = r.id;
                option.textContent = `${r.nome} (${r.paga.toFixed(2)} ‚Ç¨)`;
                select.appendChild(option);
            });
        }

        async function loadPropagandistiSelect() {
            const select = document.getElementById('select-propagandista');
            const dipendenti = await apiCall('/api/dipendenti');
            
            select.innerHTML = '<option value="">Seleziona...</option>';
            dipendenti.forEach(d => {
                const option = document.createElement('option');
                option.value = d.nome;
                option.textContent = d.nome;
                select.appendChild(option);
            });
        }

        // ============================================================
        // CALCOLO STIPENDI
        // ============================================================
        async function calcolaStipendi() {
            try {
                const stipendi = await apiCall('/api/calcola-stipendi');
                
                if (stipendi.length === 0) {
                    alert('Nessuno stipendio da calcolare (nessun tesseramento verificato)');
                    return;
                }
                
                const list = document.getElementById('stipendi-list');
                list.innerHTML = '';
                
                let totale = 0;
                
                stipendi.forEach(s => {
                    totale += s.stipendio;
                    const div = document.createElement('div');
                    div.className = 'stipendio-item';
                    div.innerHTML = `
                        <div>
                            <div class="stipendio-nome">${s.nome}</div>
                            <div class="stipendio-dettagli">${s.ruolo} ‚Ä¢ ${s.verificati} tesseramenti verificati</div>
                        </div>
                        <div class="stipendio-importo">${s.stipendio.toFixed(2)} ‚Ç¨</div>
                    `;
                    list.appendChild(div);
                });
                
                const divTotale = document.createElement('div');
                divTotale.className = 'stipendio-item';
                divTotale.style.marginTop = '15px';
                divTotale.style.borderTop = '2px solid #444';
                divTotale.innerHTML = `
                    <div>
                        <div class="stipendio-nome">TOTALE</div>
                    </div>
                    <div class="stipendio-importo">${totale.toFixed(2)} ‚Ç¨</div>
                `;
                list.appendChild(divTotale);
                
                openModal('stipendi');
            } catch (error) {
                alert('Errore nel calcolo degli stipendi');
            }
        }

        // ============================================================
        // UTILITIES
        // ============================================================
        function showLoader(section) {
            document.getElementById(`loader-${section}`).classList.add('active');
            document.getElementById(`table-${section}`).style.display = 'none';
            document.getElementById(`empty-${section}`).style.display = 'none';
        }

        function hideLoader(section) {
            document.getElementById(`loader-${section}`).classList.remove('active');
        }

        function showEmpty(section) {
            hideLoader(section);
            document.getElementById(`table-${section}`).style.display = 'none';
            document.getElementById(`empty-${section}`).style.display = 'block';
        }

        // ============================================================
        // INIT
        // ============================================================
      // ============================================================
        // INIT CON AUTO-DISCOVERY
        // ============================================================
        
        async function initApp() {
            const connected = await discoverBackend();
            
            if (!connected) {
                showIpConfigModal();
                return;
            }
            
            await checkAuth();
        }  
        window.addEventListener('DOMContentLoaded', () => {
            initApp();  // <-- Cambia da checkAuth() a initApp()
        });
    </script>

</body>
</html>
